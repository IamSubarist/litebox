import{aC as Ce,R as I,a_ as Fe,r as c,b as we,a$ as ne,a7 as je,B as Le,b0 as Pe,b1 as $e,b2 as Y,b3 as Ae,b4 as Ne,b5 as We,b6 as Q,Q as Z,j as z,a as p,z as ce,K as H,b7 as Ue,b8 as V,b9 as q,ba as Ie,bb as Te,bc as Oe,bd as _e,be as Ve,bf as de,bg as Re,bh as Je,bi as Me,bj as ze,bk as He,bl as qe,H as Ke,bm as Ge,bn as fe,bo as pe,bp as ge,bq as he,br as me,bs as be,bt as ke}from"./index.1b2e2817.js";const Qe=b=>{const d=b.name.split(".").pop()||"bin";return`${Ce().replace(/-/g,"")}.${d}`},Xe=(b,d)=>{var A,e,k,l,F;const C=[],R=new Map,y=(h,a,f,s,v)=>{if(h instanceof File){const u=Qe(h),x=h.type||"application/octet-stream";C.push({filename:u,content_type:x}),R.set(u,{file:h,path:a,blockId:f,widgetType:s,fieldPath:v})}};return b.forEach(h=>{var v;const{id:a,type:f,data:s}=h;switch(f){case"link":s.links&&Array.isArray(s.links)&&s.links.forEach((u,x)=>{u.image instanceof File&&y(u.image,`projectBlocks[${a}].data.links[${x}].image`,a,f,`data.links[${x}].image`)});break;case"carousel":s.slides&&Array.isArray(s.slides)&&s.slides.forEach((u,x)=>{u.image instanceof File&&y(u.image,`projectBlocks[${a}].data.slides[${x}].image`,a,f,`data.slides[${x}].image`)});break;case"background":((v=s.background)==null?void 0:v.image)instanceof File?y(s.background.image,`projectBlocks[${a}].data.background.image`,a,f,"data.background.image"):s.backgroundImage instanceof File&&y(s.backgroundImage,`projectBlocks[${a}].data.backgroundImage`,a,f,"data.backgroundImage");break;case"promoVideo":s.videoUrl instanceof File&&y(s.videoUrl,`projectBlocks[${a}].data.videoUrl`,a,f,"data.videoUrl"),s.thumbnail instanceof File&&y(s.thumbnail,`projectBlocks[${a}].data.thumbnail`,a,f,"data.thumbnail");break}}),d&&(((A=d.profileData)==null?void 0:A.photoUrl)instanceof File&&y(d.profileData.photoUrl,"projectSettings.profileData.photoUrl",null,"leftColProfile","photoUrl"),((e=d.videoData)==null?void 0:e.videoUrl)instanceof File&&y(d.videoData.videoUrl,"projectSettings.videoData.videoUrl",null,"leftColVideo","videoUrl"),((k=d.videoData)==null?void 0:k.thumbnail)instanceof File&&y(d.videoData.thumbnail,"projectSettings.videoData.thumbnail",null,"leftColVideo","thumbnail"),((l=d.socialLinkData)==null?void 0:l.socialLinks)&&Array.isArray(d.socialLinkData.socialLinks)&&d.socialLinkData.socialLinks.forEach((h,a)=>{h.icon instanceof File&&y(h.icon,`projectSettings.socialLinkData.socialLinks[${a}].icon`,null,"leftColSocialLink",`socialLinks[${a}].icon`)}),((F=d.buttonData)==null?void 0:F.buttons)&&Array.isArray(d.buttonData.buttons)&&d.buttonData.buttons.forEach((h,a)=>{h.icon instanceof File&&y(h.icon,`projectSettings.buttonData.buttons[${a}].icon`,null,"leftColButtonWidget",`buttons[${a}].icon`)})),{items:C,fileMap:R}},Ye=(b,d,C,R)=>{var h;const y=R.get(d);if(!y)return console.warn(`File info not found for filename: ${d}`),b;const{blockId:A,widgetType:e,fieldPath:k}=y,l=JSON.parse(JSON.stringify(b)),F=(a,f,s)=>{const v=f.split(".");let u=a;for(let w=0;w<v.length-1;w++){const B=v[w],N=B.match(/^(\w+)\[(\d+)\]$/);if(N){const[,S,T]=N;if(!u[S])return!1;u=u[S][parseInt(T)]}else{if(!u[B])return!1;u=u[B]}if(!u)return!1}const x=v[v.length-1],D=x.match(/^(\w+)\[(\d+)\]$/);if(D){const[,w,B]=D;if(u[w]&&u[w][parseInt(B)]!==void 0)return u[w][parseInt(B)]=s,!0}else if(u&&x in u)return u[x]=s,!0;return!1};if(A&&!["leftColProfile","leftColVideo","leftColSocialLink","leftColButtonWidget"].includes(e)){const a=(h=l.projectBlocks)==null?void 0:h.findIndex(f=>f.id===A);if(a!==-1&&l.projectBlocks){const f=l.projectBlocks[a];F(f,k,C)}}else l.projectSettings||(l.projectSettings={}),e==="leftColProfile"?(l.projectSettings.profileData||(l.projectSettings.profileData={}),l.projectSettings.profileData.photoUrl=C):e==="leftColVideo"?(l.projectSettings.videoData||(l.projectSettings.videoData={}),k==="videoUrl"?l.projectSettings.videoData.videoUrl=C:k==="thumbnail"&&(l.projectSettings.videoData.thumbnail=C)):e==="leftColSocialLink"?(l.projectSettings.socialLinkData||(l.projectSettings.socialLinkData={}),F(l.projectSettings.socialLinkData,k,C)):e==="leftColButtonWidget"&&(l.projectSettings.buttonData||(l.projectSettings.buttonData={}),F(l.projectSettings.buttonData,k,C));return l},Ze=I.lazy(()=>Fe(()=>import("./index.1b2e2817.js").then(b=>b.bP),["assets/index.1b2e2817.js","assets/index.682d0e2d.css"])),et=()=>{try{const b=window.localStorage.getItem("projectSettings");if(b)return JSON.parse(b)}catch(b){console.error("Error loading projectSettings from localStorage:",b)}return null},tt=b=>{try{window.localStorage.setItem("projectSettings",JSON.stringify(b))}catch(d){console.error("Error saving projectSettings to localStorage:",d)}},ut=()=>{const[b,d]=c.exports.useState("grid"),{width:C,breakpoints:R}=we(),[y,A]=c.exports.useState(!1),e=et(),[k,l]=c.exports.useState((e==null?void 0:e.circle)||!1),[F,h]=c.exports.useState((e==null?void 0:e.adult)||!1),[a,f]=c.exports.useState((e==null?void 0:e.hasVideoWidget)||!1),[s,v]=c.exports.useState((e==null?void 0:e.videoData)||{videoUrl:null,thumbnail:null}),[u,x]=c.exports.useState((e==null?void 0:e.hasSocialLinkWidget)||!1),[D,w]=c.exports.useState((e==null?void 0:e.socialLinkData)||{socialLinks:[]}),[B,N]=c.exports.useState((e==null?void 0:e.hasButtonWidget)||!1),[S,T]=c.exports.useState((e==null?void 0:e.buttonData)||{buttons:[]}),[O,ee]=c.exports.useState((e==null?void 0:e.profileData)||{photoUrl:ne,name:"Name",text:"Text under name"}),[ot,te]=c.exports.useState(!1),[J,X]=c.exports.useState(!1),[oe,xe]=c.exports.useState(new Set),K=C<R.xl,j=C<976,{projects:ye,projectBlocks:_,widgetEditor:W,shouldSaveProject:ae}=je(o=>o.project),r=Le();I.useEffect(()=>{ae&&(ie(),r(Pe()))},[ae]);const ue=I.useCallback(()=>{tt({circle:k,adult:F,hasVideoWidget:a,videoData:s,hasSocialLinkWidget:u,socialLinkData:D,hasButtonWidget:B,buttonData:S,profileData:O})},[k,F,a,s,u,D,B,S,O]),U=I.useRef(!0);c.exports.useEffect(()=>{if(U.current||J){U.current&&!J&&(U.current=!1);return}ue()},[ue,J]);const De=()=>{l(o=>!o),!J&&!U.current&&r(de())},Be=()=>{h(o=>!o),!J&&!U.current&&r(de())};c.exports.useEffect(()=>(ge(o=>{v(o),f(!0)}),he(()=>{v({videoUrl:null,thumbnail:null}),f(!1)}),()=>{ge(null),he(null)}),[]),c.exports.useEffect(()=>(fe(o=>{w(o),x(!0)}),me(()=>{w({socialLinks:[]}),x(!1)}),()=>{fe(null),me(null)}),[]),c.exports.useEffect(()=>(pe(o=>{T(o),N(!0)}),be(()=>{T({buttons:[]}),N(!1)}),()=>{pe(null),be(null)}),[]),c.exports.useEffect(()=>(ke(o=>{ee(o)}),()=>{ke(null)}),[]);const se=I.useRef(W.isOpen),le=I.useRef(W.widgetType);c.exports.useEffect(()=>{if(W.isOpen&&(le.current=W.widgetType),se.current&&!W.isOpen){const o=le.current;o==="leftColSocialLink"&&u&&((D==null?void 0:D.socialLinks)&&D.socialLinks.length>0||(w({socialLinks:[]}),x(!1))),o==="leftColButtonWidget"&&B&&((S==null?void 0:S.buttons)&&S.buttons.length>0||(T({buttons:[]}),N(!1)))}se.current=W.isOpen},[W.isOpen,W.widgetType,u,B,D,S]);const Se=$e(Y(ze,{activationConstraint:{distance:8}}),Y(Me,{activationConstraint:{delay:200,tolerance:5}}),Y(Je,{coordinateGetter:Re})),Ee=o=>{const{active:i,over:L}=o;L&&i.id!==L.id&&r(He({activeId:i.id,overId:L.id}))};c.exports.useEffect(()=>{A(!0),setTimeout(()=>{A(!1)},1500)},[b]),c.exports.useEffect(()=>{(async()=>{var L,P,E;const i=localStorage.getItem("authToken");if(!i){console.log("No auth token, skipping schema load"),X(!1),U.current=!1;return}X(!0);try{const n=await qe();let $=[];if((L=n==null?void 0:n.data)!=null&&L.projectBlocks?($=n.data.projectBlocks,r(Q($))):Array.isArray(n==null?void 0:n.data)?($=n.data,r(Q($))):Array.isArray(n)&&($=n,r(Q($))),$.some(t=>t.type==="products"))try{console.log("\u{1F6CD}\uFE0F \u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u043F\u0440\u043E\u0434\u0443\u043A\u0442\u043E\u0432 \u0434\u043B\u044F \u0432\u0438\u0434\u0436\u0435\u0442\u043E\u0432...");const t=await Ke.get("https://socialdash.leverageindo.group/api/products",{headers:{Authorization:i}});console.log("\u{1F4E6} \u041F\u043E\u043B\u0443\u0447\u0435\u043D\u044B \u043F\u0440\u043E\u0434\u0443\u043A\u0442\u044B \u0441 \u0441\u0435\u0440\u0432\u0435\u0440\u0430:",t.data);const g=t.data.items.map(m=>({id:m.id,title:m.title,shopName:m.shop_name,url:m.url,currency:m.currency_key,price:m.price,rating:m.rating,images:m.photos.map(G=>G.url),photos:m.photos,thumbnail:m.photos.length>0?m.photos[0].url:null}));console.log("\u2705 \u041F\u0440\u0435\u043E\u0431\u0440\u0430\u0437\u043E\u0432\u0430\u043D\u043D\u044B\u0435 \u043F\u0440\u043E\u0434\u0443\u043A\u0442\u044B:",g),r(Ge(g));const M=$.filter(m=>m.type==="products");console.log("\u{1F4CB} \u0411\u043B\u043E\u043A\u0438 \u043F\u0440\u043E\u0434\u0443\u043A\u0442\u043E\u0432 \u0432 \u0441\u0445\u0435\u043C\u0435:",M),M.forEach(m=>{var G;console.log(`  - \u0411\u043B\u043E\u043A ${m.id}: selectedProducts =`,(G=m.data)==null?void 0:G.selectedProducts)})}catch(t){console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0435 \u043F\u0440\u043E\u0434\u0443\u043A\u0442\u043E\u0432:",t)}if((P=n==null?void 0:n.data)!=null&&P.projectSettings){const t=n.data.projectSettings;t.circle!==void 0&&l(t.circle),t.adult!==void 0&&h(t.adult),t.hasVideoWidget!==void 0&&f(t.hasVideoWidget),t.videoData&&v(t.videoData),t.hasSocialLinkWidget!==void 0&&x(t.hasSocialLinkWidget),t.socialLinkData&&w(t.socialLinkData),t.hasButtonWidget!==void 0&&N(t.hasButtonWidget),t.buttonData&&T(t.buttonData),t.profileData&&ee(t.profileData)}U.current=!1}catch(n){console.error("Error loading schema:",n),((E=n.response)==null?void 0:E.status)!==404&&Z.error("Failed to load project schema"),U.current=!1}finally{X(!1)}})()},[r]);const ie=I.useCallback(async()=>{te(!0);try{const o={circle:k,adult:F,hasVideoWidget:a,videoData:s,hasSocialLinkWidget:u,socialLinkData:D,hasButtonWidget:B,buttonData:S,profileData:O},{items:i,fileMap:L}=Xe(_,o);console.log(`\u{1F4CB} \u041D\u0430\u0439\u0434\u0435\u043D\u043E ${i.length} \u0444\u0430\u0439\u043B\u043E\u0432 \u0434\u043B\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438:`,i.map(t=>({filename:t.filename,content_type:t.content_type})));let P=[];i.length>0&&(console.log(`\u{1F4E1} \u041E\u0442\u043F\u0440\u0430\u0432\u043B\u044F\u0435\u043C \u0437\u0430\u043F\u0440\u043E\u0441 \u043D\u0430 \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u0435 presigned URLs \u0434\u043B\u044F ${i.length} \u0444\u0430\u0439\u043B\u043E\u0432...`),P=await Ae(i),console.log(`\u{1F4E5} \u041F\u043E\u043B\u0443\u0447\u0435\u043D\u043E ${P.length} presigned URLs:`,P));let E={projectBlocks:JSON.parse(JSON.stringify(_)),projectSettings:JSON.parse(JSON.stringify(o))};P.forEach(t=>{E=Ye(E,t.filename,t.content_path,L)});const n=E.projectBlocks&&E.projectSettings?E:E.projectBlocks||E,$=Array.from(oe),re=Ne(n,$);if(P.length>0){console.log(`\u{1F4E4} \u041D\u0430\u0447\u0438\u043D\u0430\u0435\u043C \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0443 ${P.length} \u0444\u0430\u0439\u043B\u043E\u0432 \u0447\u0435\u0440\u0435\u0437 PUT \u0437\u0430\u043F\u0440\u043E\u0441\u044B...`);const t=P.map(async g=>{console.log(`\u{1F50D} \u041E\u0431\u0440\u0430\u0431\u0430\u0442\u044B\u0432\u0430\u0435\u043C \u0444\u0430\u0439\u043B: ${g.filename}`,{upload_url:g.upload_url,content_path:g.content_path});const M=L.get(g.filename);if(!M){console.error(`\u274C File info \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D \u0434\u043B\u044F filename: ${g.filename}`);return}if(!M.file){console.error(`\u274C File \u043E\u0431\u044A\u0435\u043A\u0442 \u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0434\u043B\u044F filename: ${g.filename}`);return}if(!g.upload_url){console.error(`\u274C upload_url \u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0434\u043B\u044F filename: ${g.filename}`);return}try{console.log(`\u2B06\uFE0F \u041E\u0442\u043F\u0440\u0430\u0432\u043B\u044F\u0435\u043C PUT \u0437\u0430\u043F\u0440\u043E\u0441 \u0434\u043B\u044F \u0444\u0430\u0439\u043B\u0430: ${g.filename}`),await We(M.file,g.upload_url),console.log(`\u2705 PUT \u0437\u0430\u043F\u0440\u043E\u0441 \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u0432\u044B\u043F\u043E\u043B\u043D\u0435\u043D \u0434\u043B\u044F \u0444\u0430\u0439\u043B\u0430: ${g.filename}`)}catch(m){console.error(`\u274C Failed to upload file ${g.filename}:`,m)}});Promise.all(t).then(()=>{console.log("\u2705 \u0412\u0441\u0435 \u0444\u0430\u0439\u043B\u044B \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u044B \u0447\u0435\u0440\u0435\u0437 PUT \u0437\u0430\u043F\u0440\u043E\u0441\u044B")}).catch(g=>{console.error("\u274C Error uploading files in background:",g)})}else console.log("\u2139\uFE0F \u041D\u0435\u0442 \u0444\u0430\u0439\u043B\u043E\u0432 \u0434\u043B\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 (uploadResults \u043F\u0443\u0441\u0442\u043E\u0439)");if(await re,P.length>0&&E.projectBlocks){r(Q(E.projectBlocks));const g={...JSON.parse(localStorage.getItem("projectPreviewData")||"{}"),projectBlocks:E.projectBlocks};localStorage.setItem("projectPreviewData",JSON.stringify(g))}xe(new Set),Z.success("Changes saved successfully")}catch(o){console.error("Error saving schema:",o),Z.error("Failed to save project")}finally{te(!1)}},[k,F,a,s,u,D,B,S,O,_,oe]);I.useEffect(()=>()=>{},[ie]);const ve=()=>{const o=_.filter(n=>n.type==="background"),i=_.filter(n=>n.type!=="background"),L=o.length>0?o[o.length-1]:null,E={projectBlocks:L?[...i,L]:i,projects:ye,circle:k,adult:F,hasVideoWidget:a,videoData:s,hasSocialLinkWidget:u,socialLinkData:D,hasButtonWidget:B,buttonData:S,profileData:O};localStorage.setItem("projectPreviewData",JSON.stringify(E)),window.open("/preview","_blank")};return J?z("div",{children:[p(ce,{}),p("div",{className:"flex items-center justify-center min-h-[85vh]",children:z("div",{className:"text-center",children:[p("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500 mx-auto mb-4"}),p("p",{className:"text-slate-600 dark:text-slate-400",children:"Loading project schema..."})]})})]}):z("div",{children:[p(ce,{}),z("div",{className:"flex flex-wrap justify-between items-center mb-4",children:[p("h4",{className:"font-medium lg:text-2xl text-xl capitalize text-slate-900 inline-block ltr:pr-4 rtl:pl-4",children:"Project"}),z("div",{className:`flex flex-wrap gap-2 ${j?"w-full":"md:space-x-4 md:justify-end"} items-center rtl:space-x-reverse`,children:[p(H,{icon:"mdi-light:eye",text:"Preview",className:`bg-gray-600 hover:bg-gray-700 text-white h-min text-sm font-normal ${j?"text-xs px-3 py-1.5 flex-1 min-w-[calc(33.333%-0.33rem)]":""}`,iconClass:j?"text-base":"text-lg",onClick:ve}),p(H,{icon:"heroicons-outline:plus",text:"Add widget",className:`bg-gray-600 hover:bg-gray-700 text-white h-min text-sm font-normal ${j?"text-xs px-3 py-1.5 flex-1 min-w-[calc(33.333%-0.33rem)]":""}`,iconClass:j?"text-base":"text-lg",onClick:()=>{r(Ue()),r(V(!0))}}),p(H,{icon:"ph:video-thin",text:"Add video",className:`bg-gray-600 hover:bg-gray-700 text-white h-min text-sm font-normal ${j?"text-xs px-3 py-1.5 flex-1 min-w-[calc(33.333%-0.33rem)]":""}`,iconClass:j?"text-base":"text-xl",onClick:()=>{f(!0),r(V(!0)),r(q({widgetType:"leftColVideo",widgetData:s}))}}),p(H,{icon:"fluent:color-background-24-regular",text:"Background",className:`bg-gray-600 hover:bg-gray-700 text-white h-min text-sm font-normal ${j?"text-xs px-3 py-1.5 flex-1 min-w-[calc(33.333%-0.33rem)]":""}`,iconClass:j?"text-base":"text-xl",onClick:()=>{r(q({widgetType:"background"})),r(V(!0))}}),p(H,{icon:"mdi:toggle-switch",text:k?"Circle On":"Circle Off",className:`bg-gray-600 hover:bg-gray-700 text-white h-min text-sm font-normal ${j?"text-xs px-3 py-1.5 flex-1 min-w-[calc(33.333%-0.33rem)]":""}`,iconClass:j?"text-base":"text-lg",onClick:De}),p(H,{icon:"mdi:toggle-switch",text:F?"Adult On":"Adult Off",className:`bg-gray-600 hover:bg-gray-700 text-white h-min text-sm font-normal ${j?"text-xs px-3 py-1.5 flex-1 min-w-[calc(33.333%-0.33rem)]":""}`,iconClass:j?"text-base":"text-lg",onClick:Be})]})]}),z("div",{className:`min-h-[85vh] bg-[#131517] ${K?"flex flex-col":"flex"}`,children:[p("div",{className:`${K?"w-full order-1":"w-[500px] order-1"}`,children:p(Ze,{redactor:!0,circle:k,profil:ne,profileData:O,onProfileEdit:()=>{r(V(!0)),r(q({widgetType:"leftColProfile",widgetData:O}))},hasVideoWidget:a,videoData:s,onVideoEdit:()=>{r(V(!0)),r(q({widgetType:"leftColVideo",widgetData:s}))},onVideoDelete:()=>{v({videoUrl:null,thumbnail:null}),f(!1)},hasSocialLinkWidget:u,socialLinkData:D,onSocialLinkEdit:()=>{r(V(!0)),r(q({widgetType:"leftColSocialLink",widgetData:D}))},onSocialLinkDelete:()=>{w({socialLinks:[]}),x(!1)},hasButtonWidget:B,buttonData:S,onButtonEdit:()=>{r(V(!0)),r(q({widgetType:"leftColButtonWidget",widgetData:S}))},onButtonDelete:()=>{T({buttons:[]}),N(!1)}})}),p("div",{className:`${K?"w-full order-2":"flex-1 order-2"}`,children:p("div",{className:`min-h-[100vh] py-5 ${K?"px-4":k?"ps-[50px] pe-[100px]":"px-[25px]"}`,children:p(Ie,{sensors:Se,collisionDetection:Te,onDragEnd:Ee,children:p(Oe,{items:(()=>_.filter(i=>i.type!=="background").map(i=>i.id))(),strategy:_e,children:(()=>{const o=_.filter(i=>i.type!=="background");return o.length===0?p("div",{className:"flex items-center justify-center h-[200px] text-slate-400",children:p("p",{children:"Empty"})}):o.map(i=>p(Ve,{block:i,redactor:!0},i.id))})()})})})})]})]})};export{ut as default};
